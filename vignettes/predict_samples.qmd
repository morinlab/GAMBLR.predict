---
title: "Classifying samples with DLBCLone"
vignette: >
  %\VignetteIndexEntry{quarto vignettes}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
from: markdown+emoji
fig.align: "center"
---


```{r set working directory and libs, echo=FALSE, include=FALSE}
library(GAMBLR.predict)
library(GAMBLR.helpers) 
library(tidyverse)
```

## Preamble

The most practical use for a DLBCLone model is to infer the class/subtype of samples based on the genetic features present. This is accomplished with the `DLBCLone_predict` function. This tutorial assumes you will start with a previously saved model, which you will restore from disk and re-activate as shown in the previous tutorial.


```{r, message=FALSE, warning=FALSE, echo = FALSE}
default_model <- "best_opt_w"
# Load your stored optimized model from DLBCLone_save_optimized()
best_opt_model <- DLBCLone_load_optimized( 
        dirname(
            system.file(
                "extdata/models",
                "best_opt_model.rds",
                package = "GAMBLR.predict"
            )
        ),
        default_model
    )
```

## predicting the class of a single sample 

In this demonstration, we'll use our model to predict the class of one of our training samples. This is not the normal, or particularly sensible, application of DLBCLone but it's a convenient way to demonstrate how `DLBCLone_predict` works. Since we're using a sample that was in the training data, we can directly recycle the genetic feature matrix from the model via `best_opt_model$features`. Because there are meta-features in that data frame, we also need to enable the `drop_extra` feature. 

```{r predict single sample, message=FALSE, warning=FALSE}
test_sample = "00-14595_tumorC"

pred_train <- DLBCLone_predict(
  mutation_status = best_opt_model$features[test_sample,],
  optimized_model = best_opt_model,
  drop_extra = TRUE
)

knitr::kable(head(pred_train$prediction))
```

## Visualizing a the neighborhood of a single classification

### make_neighborhood_plot 

Used for visualizing how and where neighbors are selected, a umap plot is produced showcasing the test sample of interest and its trained neighbors that helped determine its labeling.

`single_sample_prediction_output` output list from predict_single_sample_DLBCLone

`training_predictions` training predictions from DLBCLone_optimize_params (e.g. optimized_model$df)

`this_sample_id Character` the sample ID for which the neighborhood plot will be generated

`prediction_in_title` if TRUE: includes the predicted label in the plot title

`add_circle` Plot will include a circle surrounding the set of neighbors, helpful for identification

```{r make_neighborhood_plot, message=FALSE, warning=FALSE}
make_neighborhood_plot(
  single_sample_prediction_output = pred_train,
  this_sample_id = "00-14595_tumorC",
  prediction_in_title = TRUE,
  add_circle = TRUE,
  label_column = "DLBCLone_wo"
)
```

### nearest_neighbor_heatmap 

Generates a heatmap of feature values for the nearest neighbors of a specified sample, based on a DLBCLone model object. This visualization helps to inspect the feature profiles of samples most similar to the query sample.

`this_sample_id` the sample ID for which to plot the nearest neighbor heatmap

`DLBCLone_model` a DLBCLone model object, which can be the output of DLBCLone_optimize_params, DLBCLone_KNN, or DLBCLone_predict

`truth_column` the column name in the predictions data frame that contains the ground truth labels (default: "lymphgen")

`metadata_cols` optional character vector of additional metadata columns to include in the heatmap annotations

`clustering_dis` the distance metric to use for clustering rows (default: "binary")

`font_size` font size for heatmap text (default: 14)

```{r nearest_neighbor_heatmap, message=FALSE,warning=FALSE}
nearest_neighbor_heatmap(
  this_sample_id = "00-14595_tumorC",
  DLBCLone_model = pred_train,
  font_size = 7
)
```
